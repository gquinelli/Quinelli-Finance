<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quinelli Platform ¬∑ Sistema de Inversi√≥n Personal</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap');
:root {
  --bg:#07080c; --bg2:#0b0c12; --surface:#0f1018; --surface2:#151620; --surface3:#1a1b26;
  --border:rgba(255,255,255,0.06); --border2:rgba(255,255,255,0.10);
  --gold:#c8a45a; --gold2:#e8c87a; --gold-dim:rgba(200,164,90,0.12);
  --text:#eae6dc; --text2:#9e9a8e; --text3:#5a5750;
  --green:#34d399; --green-dim:rgba(52,211,153,0.10);
  --red:#f87171; --red-dim:rgba(248,113,113,0.10);
  --yellow:#fbbf24; --yellow-dim:rgba(251,191,36,0.10);
  --blue:#60a5fa; --blue-dim:rgba(96,165,250,0.10);
  --nav-w:220px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Mono',monospace;min-height:100vh;display:flex;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(196,158,72,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(196,158,72,.025) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0}
body::after{content:'';position:fixed;top:-30%;left:50%;transform:translateX(-50%);width:900px;height:600px;background:radial-gradient(ellipse,rgba(196,158,72,.04) 0%,transparent 70%);pointer-events:none;z-index:0}
.wrap{max-width:980px;margin:0 auto;padding:0 24px 80px;position:relative;z-index:1}
#sidebar{width:var(--nav-w);min-height:100vh;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100}
.sidebar-logo{padding:28px 20px 20px;border-bottom:1px solid var(--border)}
.sidebar-logo-name{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--text);letter-spacing:-0.5px;line-height:1}
.sidebar-logo-name em{color:var(--gold2);font-style:italic}
.sidebar-logo-tag{font-size:8px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;margin-top:4px}
.nav-section{padding:16px 12px 4px;font-size:7px;letter-spacing:4px;color:var(--text3);text-transform:uppercase}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:11px;letter-spacing:1px;color:var(--text2);cursor:pointer;transition:all .15s;border-left:2px solid transparent}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.02)}
.nav-item.active{color:var(--gold2);border-left-color:var(--gold);background:var(--gold-dim)}
.nav-icon{font-size:13px;width:16px;text-align:center}
.nav-badge{margin-left:auto;background:var(--red);color:var(--bg);font-size:9px;font-weight:600;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
.sidebar-bottom{margin-top:auto;padding:16px 20px;border-top:1px solid var(--border);font-size:9px;color:var(--text3);letter-spacing:1px;line-height:1.8}
#main{margin-left:var(--nav-w);flex:1;min-height:100vh;display:flex;flex-direction:column}
.page-header{padding:24px 32px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg2);position:sticky;top:0;z-index:50}
.page-title{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:600;color:var(--text);letter-spacing:-0.5px}
.page-subtitle{font-size:9px;color:var(--text3);letter-spacing:3px;margin-top:2px}
.header-actions{display:flex;gap:8px;align-items:center}
.btn{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:8px 14px;border:1px solid var(--border2);background:transparent;color:var(--text2);cursor:pointer;transition:all .15s}
.btn:hover{color:var(--text);border-color:var(--text3)}
.btn.primary{background:var(--gold);color:var(--bg);border-color:var(--gold);font-weight:600}
.btn.primary:hover{background:var(--gold2);border-color:var(--gold2)}
.btn.sm{padding:6px 10px;font-size:9px}
.page-content{padding:24px 32px;flex:1}
.section{margin-bottom:20px}
.panel{background:var(--surface);border:1px solid var(--border);overflow:hidden}
.panel-header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2)}
.panel-title{font-size:8px;letter-spacing:4px;color:var(--gold);text-transform:uppercase;opacity:.8}
.panel-body{padding:18px}
.view{display:none}
.view.active{display:block}
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.kpi{background:var(--surface);border:1px solid var(--border);padding:16px 18px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi.gold::before{background:var(--gold)} .kpi.green::before{background:var(--green)}
.kpi.red::before{background:var(--red)}   .kpi.blue::before{background:var(--blue)}
.kpi-label{font-size:8px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;margin-bottom:6px}
.kpi-value{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;line-height:1}
.kpi.gold .kpi-value{color:var(--gold2)} .kpi.green .kpi-value{color:var(--green)}
.kpi.red .kpi-value{color:var(--red)}    .kpi.blue .kpi-value{color:var(--blue)}
.kpi-sub{font-size:9px;color:var(--text3);margin-top:3px;letter-spacing:1px}
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.alert-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.alert-item:last-child{border-bottom:none}
.alert-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px}
.alert-dot.buy{background:var(--green);box-shadow:0 0 6px var(--green)}
.alert-dot.sell{background:var(--red);box-shadow:0 0 6px var(--red)}
.alert-dot.watch{background:var(--yellow);box-shadow:0 0 6px var(--yellow)}
.alert-ticker{font-size:13px;color:var(--gold2);font-family:'Cormorant Garamond',serif;font-weight:600}
.alert-msg{font-size:10px;color:var(--text2);margin-top:2px;letter-spacing:.3px;line-height:1.4}
.sug-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer}
.sug-item:last-child{border-bottom:none}
.sug-item:hover .si-ticker{color:var(--gold2)}
.si-ticker{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:700;color:var(--text);min-width:55px}
.si-name{font-size:9px;color:var(--text3);letter-spacing:.5px}
.si-verdict{margin-left:auto;font-size:8px;letter-spacing:2px;padding:2px 7px;border:1px solid}
.si-verdict.COMPRA_AGRESIVA{color:#22c55e;border-color:rgba(34,197,94,.3)}
.si-verdict.COMPRA{color:var(--green);border-color:rgba(52,211,153,.3)}
.si-verdict.MANTENER{color:var(--yellow);border-color:rgba(251,191,36,.3)}
.si-score{font-size:10px;color:var(--text3);min-width:24px;text-align:right}
.portfolio-table{width:100%;border-collapse:collapse}
.portfolio-table th{font-size:8px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;text-align:left;padding:8px 10px;border-bottom:1px solid var(--border)}
.portfolio-table td{padding:10px 10px;font-size:11px;border-bottom:1px solid var(--border);vertical-align:middle}
.portfolio-table tr:last-child td{border-bottom:none}
.portfolio-table tr:hover td{background:rgba(255,255,255,.01)}
.pt-ticker{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:700;color:var(--gold2)}
.pt-type{font-size:7px;letter-spacing:2px;padding:2px 5px;border:1px solid var(--border);color:var(--text3)}
.pt-pnl.pos{color:var(--green)} .pt-pnl.neg{color:var(--red)}
.pt-verdict.COMPRA_AGRESIVA{color:#22c55e} .pt-verdict.COMPRA{color:var(--green)}
.pt-verdict.MANTENER{color:var(--yellow)} .pt-verdict.VENTA{color:#fb923c}
.pt-verdict.VENTA_AGRESIVA{color:var(--red)}
.hist-table{width:100%;border-collapse:collapse}
.hist-table th{font-size:8px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;text-align:left;padding:7px 10px;border-bottom:1px solid var(--border)}
.hist-table td{padding:8px 10px;font-size:10px;border-bottom:1px solid var(--border)}
.hist-table tr:last-child td{border-bottom:none}
.op-buy{color:var(--green)} .op-sell{color:var(--red)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(7,8,12,.85);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid rgba(200,164,90,.3);width:460px;max-width:95vw;animation:mIn .25s ease}
@keyframes mIn{from{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:none}}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--text)}
.modal-close{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer}
.modal-close:hover{color:var(--text)}
.modal-body{padding:20px;display:grid;gap:12px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-label{font-size:8px;letter-spacing:4px;color:var(--gold);text-transform:uppercase;opacity:.8}
.form-input,.form-select{background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:13px;padding:9px 12px;outline:none;transition:border-color .2s}
.form-input:focus,.form-select:focus{border-color:var(--gold)}
.form-select option{background:var(--bg)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.analysis-input-row{display:flex;gap:8px;margin-bottom:16px}
.ai-input{flex:1;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;letter-spacing:3px;padding:11px 15px;outline:none;text-transform:uppercase;transition:border-color .2s}
.ai-input:focus{border-color:var(--gold)}
.ai-input::placeholder{color:var(--text3);font-size:16px;letter-spacing:2px}
.type-filters{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.tf{font-size:9px;letter-spacing:2px;padding:5px 10px;border:1px solid var(--border2);background:transparent;color:var(--text3);cursor:pointer;transition:all .15s;text-transform:uppercase}
.tf:hover{color:var(--text2);border-color:var(--text3)}
.tf.active{color:var(--gold2);border-color:var(--gold);background:var(--gold-dim)}
.stock-card{background:var(--surface);border:1px solid var(--border);margin-bottom:14px;overflow:hidden;animation:rise .4s ease}
@keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.sc-top{display:flex;align-items:stretch;border-bottom:1px solid var(--border)}
.sc-ticker-blk{padding:16px 22px;border-right:1px solid var(--border);min-width:120px}
.sc-ticker{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--gold2);letter-spacing:2px;line-height:1}
.sc-company{font-size:9px;color:var(--text2);margin-top:4px;letter-spacing:.5px}
.sc-type-tag{font-size:8px;color:var(--text3);margin-top:2px;letter-spacing:1px}
.sc-verdict-blk{flex:1;padding:16px 22px;border-right:1px solid var(--border)}
.sc-v-eye{font-size:7px;letter-spacing:5px;color:var(--text3);text-transform:uppercase;margin-bottom:5px}
.sc-verdict{font-family:'Cormorant Garamond',serif;font-size:clamp(18px,3vw,28px);font-weight:700;letter-spacing:2px}
.v-COMPRA_AGRESIVA{color:#22c55e} .v-COMPRA{color:var(--green)}
.v-MANTENER{color:var(--yellow)} .v-VENTA{color:#fb923c} .v-VENTA_AGRESIVA{color:var(--red)}
.sc-reason{font-size:10px;color:var(--text2);margin-top:4px;letter-spacing:.3px;line-height:1.5}
.sc-score-blk{padding:16px 22px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:95px}
.score-ring{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:700;border:2px solid}
.score-ring.high{border-color:var(--green);color:var(--green);background:var(--green-dim)}
.score-ring.mid{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-dim)}
.score-ring.low{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.score-lbl{font-size:7px;letter-spacing:3px;color:var(--text3);margin-top:4px;text-transform:uppercase}
.sc-body{padding:18px 22px}
.sec-title{font-size:7px;letter-spacing:5px;color:var(--gold);text-transform:uppercase;opacity:.7;margin-bottom:10px}
.sec-title.mt{margin-top:16px}
.ratios-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(105px,1fr));gap:8px;margin-bottom:4px}
.ratio-chip{background:var(--surface2);border:1px solid var(--border);padding:10px 11px;position:relative}
.ratio-chip.ok{border-left:2px solid var(--green)} .ratio-chip.warn{border-left:2px solid var(--yellow)}
.ratio-chip.bad{border-left:2px solid var(--red)}  .ratio-chip.neutral{border-left:2px solid var(--text3)}
.rc-n{font-size:7px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:4px}
.rc-v{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:600;line-height:1}
.ratio-chip.ok .rc-v{color:var(--green)} .ratio-chip.warn .rc-v{color:var(--yellow)}
.ratio-chip.bad .rc-v{color:var(--red)}  .ratio-chip.neutral .rc-v{color:var(--text2)}
.rc-b{font-size:8px;color:var(--text3);margin-top:2px}
.rc-i{position:absolute;top:5px;right:7px;font-size:9px}
.rc-i.ok{color:var(--green)} .rc-i.warn{color:var(--yellow)} .rc-i.bad{color:var(--red)}
.q-pills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:4px}
.qp{display:flex;align-items:center;gap:4px;font-size:9px;padding:3px 9px;border:1px solid;letter-spacing:.5px}
.qp.pass{color:var(--green);border-color:rgba(52,211,153,.25);background:var(--green-dim)}
.qp.fail{color:var(--red);border-color:rgba(248,113,113,.25);background:var(--red-dim)}
.qp.warn{color:var(--yellow);border-color:rgba(251,191,36,.25);background:var(--yellow-dim)}
.struct-pills{display:flex;flex-wrap:wrap;gap:5px}
.sp{font-size:9px;padding:3px 9px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);letter-spacing:.5px}
.esc-row{display:flex;gap:3px;margin:5px 0}
.esc-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.esc-bw{width:100%;height:34px;display:flex;align-items:flex-end}
.esc-b{width:100%;background:var(--surface2);border:1px solid var(--border)}
.esc-b.buy{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.35)}
.esc-b.sell{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.35)}
.esc-b.hold{background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.35)}
.esc-b.now{outline:2px solid var(--gold2);outline-offset:2px}
.esc-p{font-size:7px;color:var(--text3);text-align:center} .esc-a{font-size:6px;color:var(--text3);text-align:center;opacity:.7}
.sc-narrative{font-size:11px;line-height:1.85;color:var(--text2);letter-spacing:.2px;margin-top:5px}
.sc-narrative strong{color:var(--text);font-weight:500}
.sc-actions{display:flex;gap:7px;padding:11px 22px;border-top:1px solid var(--border);background:var(--surface2)}
.sug-controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.sug-card{background:var(--surface);border:1px solid var(--border);margin-bottom:10px;display:flex;align-items:center;gap:14px;padding:14px 18px;cursor:pointer;transition:border-color .15s}
.sug-card:hover{border-color:var(--gold)}
.sug-card-ticker{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;color:var(--gold2);min-width:72px;letter-spacing:1px}
.sug-card-info{flex:1}
.sug-card-name{font-size:11px;color:var(--text);letter-spacing:.3px}
.sug-card-why{font-size:9px;color:var(--text2);margin-top:3px;letter-spacing:.3px;line-height:1.4}
.sug-card-meta{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
.sug-v{font-size:8px;letter-spacing:2px;padding:2px 8px;border:1px solid}
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 130px)}
.chat-msgs{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:14px}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border2)}
.msg{display:flex;gap:10px;max-width:80%;animation:rise .3s ease}
.msg.user{flex-direction:row-reverse;align-self:flex-end}
.msg-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;border:1px solid var(--border2);margin-top:2px}
.msg.agent .msg-av{background:var(--gold-dim);color:var(--gold2)}
.msg.user  .msg-av{background:var(--surface2);color:var(--text2)}
.msg-bubble{padding:11px 14px;font-size:11px;line-height:1.75;letter-spacing:.2px;max-width:100%}
.msg.agent .msg-bubble{background:var(--surface);border:1px solid var(--border);color:var(--text2);border-radius:0 6px 6px 6px}
.msg.user  .msg-bubble{background:var(--gold-dim);border:1px solid rgba(200,164,90,.2);color:var(--text);border-radius:6px 0 6px 6px}
.msg-bubble strong{color:var(--text);font-weight:500}
.msg-time{font-size:8px;color:var(--text3);margin-top:3px;letter-spacing:1px}
.msg.user .msg-time{text-align:right}
.chat-iz{border-top:1px solid var(--border);padding:12px 18px;display:flex;gap:8px;background:var(--bg2)}
#chatInput{flex:1;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;padding:9px 14px;outline:none;transition:border-color .2s;resize:none;height:42px;letter-spacing:.2px}
#chatInput:focus{border-color:var(--gold)}
#chatInput::placeholder{color:var(--text3)}
.chat-quick{display:flex;gap:6px;flex-wrap:wrap;padding:8px 18px 0}
.quick-btn{font-size:9px;letter-spacing:1px;padding:4px 9px;border:1px solid var(--border2);background:transparent;color:var(--text3);cursor:pointer;transition:all .15s}
.quick-btn:hover{color:var(--gold2);border-color:var(--gold)}
.load-pulse{display:flex;gap:4px;align-items:center;padding:6px 0;justify-content:center}
.load-pulse span{width:5px;height:5px;border-radius:50%;background:var(--gold);animation:lp .8s ease-in-out infinite}
.load-pulse span:nth-child(2){animation-delay:.15s}
.load-pulse span:nth-child(3){animation-delay:.3s}
@keyframes lp{0%,80%,100%{opacity:.2}40%{opacity:1}}
.extra-data{display:flex;flex-wrap:wrap;gap:5px;margin:5px 0}
.ed-chip{font-size:9px;padding:3px 9px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);letter-spacing:.5px}
.ed-chip.h{color:var(--green);border-color:rgba(52,211,153,.25)} .ed-chip.w{color:var(--yellow);border-color:rgba(251,191,36,.25)}
.strategy-box{padding:12px 14px;background:var(--blue-dim);border:1px solid rgba(96,165,250,.2);font-size:11px;color:var(--text2);line-height:1.7;margin-top:8px}
@media(max-width:768px){
  #sidebar{transform:translateX(-100%)} #sidebar.open{transform:none}
  #main{margin-left:0} .kpi-grid{grid-template-columns:1fr 1fr} .dash-grid{grid-template-columns:1fr}
  .page-content{padding:14px} .page-header{padding:14px}
}
</style>
</head>
<body>

<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-name">Q<em>uinelli</em></div>
    <div class="sidebar-logo-tag">Plataforma ¬∑ 2026</div>
  </div>
  <div class="nav-section">Principal</div>
  <div class="nav-item active" onclick="showView('dashboard')"><span class="nav-icon">‚óà</span> Dashboard</div>
  <div class="nav-section">Herramientas</div>
  <div class="nav-item" onclick="showView('analisis')"><span class="nav-icon">‚óé</span> An√°lisis Quinelli</div>
  <div class="nav-item" onclick="showView('portfolio')"><span class="nav-icon">‚ó´</span> Mi Portfolio</div>
  <div class="nav-item" onclick="showView('sugerencias')"><span class="nav-icon">‚óâ</span> Sugerencias <span class="nav-badge" id="sugBadge" style="display:none">0</span></div>
  <div class="nav-item" onclick="showView('chat')"><span class="nav-icon">‚ó∑</span> Chat con Quinelli</div>
  <div class="sidebar-bottom">FRAMEWORK QUINELLI<br>VERSI√ìN EVOLUCIONADA 2026<br>SOLO USO EDUCATIVO</div>
</nav>

<div id="main">

<!-- DASHBOARD -->

<div id="view-dashboard" class="view active">
  <div class="page-header">
    <div><div class="page-title">Dashboard</div><div class="page-subtitle">RESUMEN ¬∑ ALERTAS ¬∑ OPORTUNIDADES</div></div>
    <div class="header-actions"><button class="btn sm" onclick="refreshAll()">‚Üª Actualizar</button></div>
  </div>
  <div class="page-content">
    <div class="kpi-grid">
      <div class="kpi gold"><div class="kpi-label">Portfolio Total</div><div class="kpi-value" id="k-total">$0</div><div class="kpi-sub" id="k-pos">0 posiciones</div></div>
      <div class="kpi green"><div class="kpi-label">P&L No Realizado</div><div class="kpi-value" id="k-pnl">$0</div><div class="kpi-sub" id="k-pnl-pct">+0.00%</div></div>
      <div class="kpi blue"><div class="kpi-label">Mejor Posici√≥n</div><div class="kpi-value" id="k-best">‚Äî</div><div class="kpi-sub" id="k-best-sub">‚Äî</div></div>
      <div class="kpi red"><div class="kpi-label">Alertas Escalera</div><div class="kpi-value" id="k-alerts">0</div><div class="kpi-sub">activas ahora</div></div>
    </div>
    <div class="dash-grid">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Alertas de Escalera Quinelli</div><button class="btn sm" onclick="renderAlerts()">‚Üª</button></div>
        <div class="panel-body" id="alertsWidget"><div style="font-size:10px;color:var(--text3);text-align:center;padding:20px;letter-spacing:2px;">AGREG√Å POSICIONES PARA VER ALERTAS</div></div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Sugerencias del Agente</div><button class="btn sm" onclick="showView('sugerencias')">Ver todas ‚Üí</button></div>
        <div class="panel-body" id="sugWidget"><div class="load-pulse"><span></span><span></span><span></span></div></div>
      </div>
    </div>
  </div>
</div>

<!-- AN√ÅLISIS -->

<div id="view-analisis" class="view">
  <div class="page-header">
    <div><div class="page-title">An√°lisis Quinelli</div><div class="page-subtitle">ACCIONES ¬∑ ETF ¬∑ OPCIONES</div></div>
  </div>
  <div class="page-content">
    <div class="analysis-input-row">
      <input id="aiInput" class="ai-input" type="text" placeholder="AAPL, SPY, NVDA..." autocomplete="off" spellcheck="false"/>
      <button class="btn primary" onclick="runAnalysis()">ANALIZAR ‚Üí</button>
    </div>
    <div class="type-filters">
      <button class="tf active" onclick="setFilter(this,'all')">Todos</button>
      <button class="tf" onclick="setFilter(this,'stock')">Acciones</button>
      <button class="tf" onclick="setFilter(this,'etf')">ETF</button>
      <button class="tf" onclick="setFilter(this,'option')">Opciones</button>
    </div>
    <div id="aLoading" style="display:none;padding:28px;text-align:center;"><div class="load-pulse"><span></span><span></span><span></span></div><div style="font-size:9px;color:var(--text3);letter-spacing:3px;margin-top:10px;">CONSULTANDO FRAMEWORK QUINELLI</div></div>
    <div id="aError" style="display:none;background:var(--red-dim);border:1px solid rgba(248,113,113,.3);padding:12px 18px;font-size:11px;color:var(--red);margin-bottom:14px;letter-spacing:1px;"></div>
    <div id="aResults"></div>
  </div>
</div>

<!-- PORTFOLIO -->

<div id="view-portfolio" class="view">
  <div class="page-header">
    <div><div class="page-title">Mi Portfolio</div><div class="page-subtitle">POSICIONES ¬∑ HISTORIAL ¬∑ P&L</div></div>
    <div class="header-actions">
      <button class="btn sm" onclick="refreshVerdicts()">‚Üª Actualizar veredictos</button>
      <button class="btn primary sm" onclick="openModal()">+ Agregar posici√≥n</button>
    </div>
  </div>
  <div class="page-content">
    <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="kpi gold"><div class="kpi-label">Valor Total</div><div class="kpi-value" id="p-total">$0</div><div class="kpi-sub" id="p-cnt">0 posiciones</div></div>
      <div class="kpi green"><div class="kpi-label">P&L No Realizado</div><div class="kpi-value" id="p-pnl">$0.00</div><div class="kpi-sub" id="p-pct">+0.00%</div></div>
      <div class="kpi blue"><div class="kpi-label">P&L Realizado</div><div class="kpi-value" id="p-real">$0.00</div><div class="kpi-sub">operaciones cerradas</div></div>
    </div>
    <div class="panel section">
      <div class="panel-header"><div class="panel-title">Posiciones Abiertas</div></div>
      <div id="portEmpty" style="padding:28px;text-align:center;font-size:10px;color:var(--text3);letter-spacing:2px;">NO TEN√âS POSICIONES ¬∑ HAC√â CLIC EN "+ AGREGAR POSICI√ìN"</div>
      <div style="overflow-x:auto;"><table class="portfolio-table" id="portTable" style="display:none"><thead><tr><th>Ticker</th><th>Tipo</th><th>Qty</th><th>Entrada</th><th>Actual</th><th>P&L $</th><th>P&L %</th><th>Veredicto</th><th></th></tr></thead><tbody id="portBody"></tbody></table></div>
    </div>
    <div class="panel section">
      <div class="panel-header"><div class="panel-title">Historial de Operaciones</div></div>
      <div id="histEmpty" style="padding:20px;text-align:center;font-size:10px;color:var(--text3);letter-spacing:2px;">SIN OPERACIONES A√öN</div>
      <div style="overflow-x:auto;"><table class="hist-table" id="histTable" style="display:none"><thead><tr><th>Fecha</th><th>Ticker</th><th>Tipo</th><th>Op.</th><th>Qty</th><th>Precio</th><th>Total</th><th>Notas</th></tr></thead><tbody id="histBody"></tbody></table></div>
    </div>
  </div>
</div>

<!-- SUGERENCIAS -->

<div id="view-sugerencias" class="view">
  <div class="page-header">
    <div><div class="page-title">Sugerencias del Agente</div><div class="page-subtitle">OPORTUNIDADES DETECTADAS ¬∑ ACTUALIZACI√ìN DIARIA</div></div>
    <div class="header-actions"><button class="btn primary sm" onclick="loadSuggestions()">‚Üª Generar nuevas</button></div>
  </div>
  <div class="page-content">
    <div class="sug-controls">
      <button class="tf active" onclick="filterSug(this,'all')">Todas</button>
      <button class="tf" onclick="filterSug(this,'COMPRA_AGRESIVA')">Compra Agresiva</button>
      <button class="tf" onclick="filterSug(this,'COMPRA')">Compra</button>
      <button class="tf" onclick="filterSug(this,'etf')">ETF</button>
      <button class="tf" onclick="filterSug(this,'option')">Opciones</button>
    </div>
    <div id="sLoading" style="display:none;padding:28px;text-align:center;"><div class="load-pulse"><span></span><span></span><span></span></div><div style="font-size:9px;color:var(--text3);letter-spacing:3px;margin-top:10px;">GENERANDO SUGERENCIAS QUINELLI</div></div>
    <div id="sugContainer"></div>
  </div>
</div>

<!-- CHAT -->

<div id="view-chat" class="view">
  <div class="page-header">
    <div><div class="page-title">Chat con Quinelli</div><div class="page-subtitle">AN√ÅLISIS ¬∑ ESTRATEGIA ¬∑ OPCIONES ¬∑ PREGUNTAS LIBRES</div></div>
    <div class="header-actions"><button class="btn sm" onclick="clearChat()">‚Üª Nueva sesi√≥n</button></div>
  </div>
  <div class="chat-quick">
    <button class="quick-btn" onclick="sendQ('¬øCu√°les son las mejores acciones para comprar hoy seg√∫n el framework Quinelli?')">Mejores compras hoy</button>
    <button class="quick-btn" onclick="sendQ('¬øQu√© ETF recomend√°s para largo plazo bajo el framework Quinelli?')">ETF largo plazo</button>
    <button class="quick-btn" onclick="sendQ('Explicame c√≥mo usar la escalera Quinelli en la pr√°ctica con un ejemplo')">C√≥mo usar la escalera</button>
    <button class="quick-btn" onclick="sendQ('Analizame opciones CALL de NVDA para el pr√≥ximo trimestre bajo el framework Quinelli')">Opciones NVDA</button>
    <button class="quick-btn" onclick="sendQ('¬øCu√°l es la diferencia entre COMPRA AGRESIVA y COMPRA en el framework?')">Compra vs Compra Agresiva</button>
  </div>
  <div class="chat-wrap">
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg agent">
        <div class="msg-av">Q</div>
        <div>
          <div class="msg-bubble">Bienvenido a <strong>Quinelli Platform</strong>. Soy tu agente personal de inversi√≥n, entrenado en el <strong>Framework Quinelli Evolucionado 2026</strong>.<br><br>Pod√©s preguntarme sobre cualquier <strong>acci√≥n, ETF u opci√≥n</strong> del mercado de EE.UU. Analizo ratios financieros, calidad empresarial, estructura t√©cnica BOS/HH/HL y posici√≥n en la escalera de compra/venta.<br><br>Tambi√©n puedo <strong>sugerirte oportunidades</strong>, revisar tu portfolio, o explicarte cualquier concepto del framework. ¬øEmpezamos?</div>
          <div class="msg-time">HOY ¬∑ QUINELLI AGENT</div>
        </div>
      </div>
    </div>
    <div class="chat-iz">
      <textarea id="chatInput" placeholder="Preguntame sobre acciones, ETF, opciones, estrategia de entrada/salida..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button class="btn primary" onclick="sendChat()">ENVIAR ‚Üí</button>
    </div>
  </div>
</div>

</div><!-- /main -->

<!-- MODAL -->

<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Agregar Posici√≥n</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ticker</label><input class="form-input" id="m-t" type="text" placeholder="AAPL" style="text-transform:uppercase" autocomplete="off"/></div>
        <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" id="m-tp"><option value="stock">Acci√≥n</option><option value="etf">ETF</option><option value="option">Opci√≥n</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Cantidad</label><input class="form-input" id="m-q" type="number" placeholder="10" min="0.01" step="0.01"/></div>
        <div class="form-group"><label class="form-label">Precio entrada ($)</label><input class="form-input" id="m-p" type="number" placeholder="150.00" min="0.01" step="0.01"/></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Precio actual ($)</label><input class="form-input" id="m-c" type="number" placeholder="168.50" min="0.01" step="0.01"/></div>
        <div class="form-group"><label class="form-label">Fecha entrada</label><input class="form-input" id="m-d" type="date"/></div>
      </div>
      <div class="form-group"><label class="form-label">Notas (opcional)</label><input class="form-input" id="m-n" type="text" placeholder="Compra escal√≥n -15% ¬∑ BOS alcista confirmado"/></div>
    </div>
    <div class="modal-footer">
      <button class="btn sm" onclick="closeModal()">Cancelar</button>
      <button class="btn primary sm" onclick="addPosition()">Agregar ‚Üí</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let portfolio = JSON.parse(localStorage.getItem('qPort')||'[]');
let history   = JSON.parse(localStorage.getItem('qHist')||'[]');
let suggs     = JSON.parse(localStorage.getItem('qSugg')||'[]');
let chatHist  = [];
let assetFilter = 'all';
let sugFilter   = 'all';

const STEPS=[
  {p:'-35%',t:'buy',a:'Fuerte',h:38},{p:'-25%',t:'buy',a:'25%',h:28},{p:'-15%',t:'buy',a:'10%',h:18},
  {p:'-5%',t:'hold',a:'Hold',h:12},{p:'BASE',t:'hold',a:'‚Äî',h:14},
  {p:'+25%',t:'sell',a:'Vender 10%',h:14},{p:'+35%',t:'sell',a:'20%',h:20},
  {p:'+45%',t:'sell',a:'30%',h:26},{p:'+60%',t:'sell',a:'40%',h:32},{p:'+100%',t:'sell',a:'Cierre',h:38}
];
const VM={COMPRA_AGRESIVA:'COMPRA AGRESIVA',COMPRA:'COMPRA',MANTENER:'MANTENER',VENTA:'VENTA',VENTA_AGRESIVA:'VENTA AGRESIVA'};

function save(){
  localStorage.setItem('qPort',JSON.stringify(portfolio));
  localStorage.setItem('qHist',JSON.stringify(history));
  localStorage.setItem('qSugg',JSON.stringify(suggs));
}

// ‚ïê‚ïê NAV ‚ïê‚ïê
function showView(n){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
  document.getElementById('view-'+n).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(i=>{if(i.getAttribute('onclick')&&i.getAttribute('onclick').includes("'"+n+"'"))i.classList.add('active')});
  if(n==='dashboard'){updateKPIs();renderAlerts()}
  if(n==='portfolio')renderPortfolio();
  if(n==='sugerencias'){if(suggs.length===0)loadSuggestions();else renderSuggs()}
}

// ‚ïê‚ïê API ‚ïê‚ïê
async function api(messages,system=''){
  const body={model:'claude-sonnet-4-20250514',max_tokens:4000,messages};
  if(system)body.system=system;
  const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok)throw new Error('API '+r.status);
  const d=await r.json();
  return d.content?.find(b=>b.type==='text')?.text||'';
}

function parseJ(t){const m=t.match(/```json\s*([\s\S]*?)```/);return JSON.parse(m?m[1]:t.trim())}

// ‚ïê‚ïê ANALYSIS ‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('aiInput').addEventListener('keydown',e=>{if(e.key==='Enter')runAnalysis()});
  updateKPIs();renderAlerts();
  if(suggs.length>0){renderSuggWidget();setBadge()}
  else loadSuggestions();
});

function setFilter(btn,f){document.querySelectorAll('.type-filters .tf').forEach(b=>b.classList.remove('active'));btn.classList.add('active');assetFilter=f}

async function runAnalysis(){
  const raw=document.getElementById('aiInput').value.trim();
  if(!raw)return;
  const tickers=raw.split(',').map(t=>t.trim().toUpperCase()).filter(Boolean);
  document.getElementById('aLoading').style.display='block';
  document.getElementById('aError').style.display='none';
  document.getElementById('aResults').innerHTML='';
  try{
    const txt=await api([{role:'user',content:buildAnalysisPrompt(tickers,assetFilter)}]);
    const d=parseJ(txt);
    renderCards(d.stocks||[]);
  }catch(e){
    document.getElementById('aError').style.display='block';
    document.getElementById('aError').textContent='‚ö† '+e.message;
  }finally{document.getElementById('aLoading').style.display='none'}
}

function buildAnalysisPrompt(tickers,f){
  const fc=f==='etf'?'Son ETFs. Inclu√≠: expense_ratio, aum, yield, num_holdings, top_holdings (array de 3).':
    f==='option'?'Son opciones. Inclu√≠: underlying, option_type (CALL/PUT), strike, expiration, iv, delta, theta, strategy_note.':'';
  return `Sos el Agente Quinelli. ${fc}

FRAMEWORK QUINELLI 2026:
FILTRO CALIDAD: ROE>18-20% sostenido 3a, FCF positivo+creciente, D/E controlado por sector, EPS Growth consistente, moat claro.
ESCALERA COMPRA: -5% mantener, -15% comprar 10%, -25% comprar 25%, -35% completar posici√≥n.
ESCALERA VENTA: +25% vender 10%, +35% vender 20%, +45% vender 30%, +60% vender 40%, +100% considerar cierre (compounders: mantener n√∫cleo 20-30%).
DIAGN√ìSTICO CA√çDA: mercado general / evento temporal / deterioro estructural ‚Üí solo escalera si NO hay deterioro.
T√âCNICA: BOS (cuerpo vela, no mecha), HH+HL alcista, LL+LH bajista, CHoCH reversi√≥n.
VEREDICTO: COMPRA_AGRESIVA/COMPRA/MANTENER/VENTA/VENTA_AGRESIVA.
SCORE 0-100: calidad 40pts + ratios 30pts + estructura 20pts + timing 10pts.

Analiz√° con datos reales aproximados 2024-2025: ${tickers.join(', ')}

Responde SOLO JSON:
\`\`\`json
{"stocks":[{"ticker":"AAPL","company":"Apple Inc.","sector":"Tecnolog√≠a","asset_type":"stock","score":78,"verdict":"MANTENER","verdictReason":"Compounder de primer nivel. Precio justo. Esperar -15% para agregar.","ratios":[{"name":"P/E","value":"31.2x","status":"warn","bench":"Sector ~28x"},{"name":"P/B","value":"45.8x","status":"warn","bench":"ROE justifica"},{"name":"ROE","value":"160%","status":"ok","bench":">20% ‚úì"},{"name":"D/E","value":"1.8x","status":"warn","bench":"Tech tolera 2x"},{"name":"FCF Yield","value":"3.8%","status":"ok","bench":">3% ‚úì"},{"name":"EPS Growth","value":"+9%","status":"warn","bench":"Desacelerando"},{"name":"Margen Neto","value":"26.4%","status":"ok","bench":">15% ‚úì"},{"name":"Curr. Ratio","value":"0.87x","status":"warn","bench":"Gestiona bien caja"}],"quality":[{"check":"ROE >18% 3 a√±os","status":"pass"},{"check":"FCF positivo y creciente","status":"pass"},{"check":"Deuda controlada","status":"warn"},{"check":"EPS Growth consistente","status":"warn"},{"check":"Ventaja competitiva (moat)","status":"pass"}],"structure":{"trend":"Alcista (HH+HL)","bos":"BOS alcista hace 3 meses","zone":"En resistencia ‚Äî esperar pullback"},"escaleraPosition":"hold","analysis":"An√°lisis detallado aqu√≠."}]}
\`\`\`
Ahora analiz√°: ${tickers.join(', ')}`;
}

function renderCards(stocks){
  const c=document.getElementById('aResults');c.innerHTML='';
  stocks.forEach(s=>{
    const vk=(s.verdict||'MANTENER').toUpperCase().replace(/\s+/g,'_');
    const sc=parseInt(s.score)||50;
    const scC=sc>=70?'high':sc>=45?'mid':'low';
    const ratHTML=(s.ratios||[]).map(r=>`<div class="ratio-chip ${r.status||'neutral'}"><div class="rc-n">${r.name}</div><div class="rc-v">${r.value}</div><div class="rc-b">${r.bench}</div><div class="rc-i ${r.status||'neutral'}">${r.status==='ok'?'‚úì':r.status==='bad'?'‚úó':'~'}</div></div>`).join('');
    const qHTML=(s.quality||[]).map(q=>`<div class="qp ${q.status}">${q.status==='pass'?'‚úì':q.status==='fail'?'‚úó':'~'} ${q.check}</div>`).join('');
    const str=s.structure||{};
    const stHTML=[str.trend?`<div class="sp">${str.trend.toLowerCase().includes('alcist')?'üìà':'üìâ'} ${str.trend}</div>`:'',str.bos?`<div class="sp">‚ö° ${str.bos}</div>`:'',str.zone?`<div class="sp">üìç ${str.zone}</div>`:''].join('');
    const pos=(s.escaleraPosition||'hold').toLowerCase();
    const escHTML=STEPS.map(st=>{const now=(pos==='hold'&&st.p==='BASE')||(pos==='buy'&&st.p==='-15%')||(pos.includes('aggressive')&&pos.includes('buy')&&st.p==='-35%')||(pos==='sell'&&st.p==='+25%')||(pos.includes('aggressive')&&pos.includes('sell')&&st.p==='+60%');return`<div class="esc-col"><div class="esc-bw"><div class="esc-b ${st.t}${now?' now':''}" style="height:${st.h}px"></div></div><div class="esc-p">${st.p}</div><div class="esc-a">${st.a}</div></div>`}).join('');
    let extra='';
    if(s.expense_ratio||s.aum){extra=`<div class="sec-title mt">ETF ¬∑ DATOS</div><div class="extra-data">${s.expense_ratio?`<div class="ed-chip w">Expense: ${s.expense_ratio}</div>`:''}${s.aum?`<div class="ed-chip w">AUM: ${s.aum}</div>`:''}${s.yield?`<div class="ed-chip h">Yield: ${s.yield}</div>`:''}${s.num_holdings?`<div class="ed-chip">Holdings: ${s.num_holdings}</div>`:''}</div>`}
    if(s.option_type||s.strike){extra=`<div class="sec-title mt">OPCI√ìN ¬∑ DATOS</div><div class="extra-data">${s.option_type?`<div class="ed-chip ${s.option_type==='CALL'?'h':'ed-chip'}">${s.option_type}</div>`:''}${s.strike?`<div class="ed-chip w">Strike: $${s.strike}</div>`:''}${s.expiration?`<div class="ed-chip w">Vence: ${s.expiration}</div>`:''}${s.iv?`<div class="ed-chip w">IV: ${s.iv}</div>`:''}${s.delta?`<div class="ed-chip">Œî ${s.delta}</div>`:''}${s.theta?`<div class="ed-chip">Œ∏ ${s.theta}</div>`:''}</div>${s.strategy_note?`<div class="strategy-box">${s.strategy_note}</div>`:''}`}
    const div=document.createElement('div');div.className='stock-card';
    div.innerHTML=`<div class="sc-top">
      <div class="sc-ticker-blk"><div class="sc-ticker">${s.ticker}</div><div class="sc-company">${s.company||''}</div><div class="sc-type-tag">${(s.asset_type||'stock').toUpperCase()} ¬∑ ${s.sector||''}</div></div>
      <div class="sc-verdict-blk"><div class="sc-v-eye">Veredicto Quinelli</div><div class="sc-verdict v-${vk}">${VM[vk]||s.verdict}</div><div class="sc-reason">${s.verdictReason||''}</div></div>
      <div class="sc-score-blk"><div class="score-ring ${scC}">${sc}</div><div class="score-lbl">SCORE</div></div>
    </div>
    <div class="sc-body">
      <div class="sec-title">Ratios Financieros Clave</div><div class="ratios-grid">${ratHTML}</div>
      <div class="sec-title mt">Filtro de Calidad Quinelli</div><div class="q-pills">${qHTML}</div>
      <div class="sec-title mt">Estructura T√©cnica ¬∑ BOS / HH / HL</div><div class="struct-pills">${stHTML}</div>
      <div class="sec-title mt">Escalera Quinelli</div><div class="esc-row">${escHTML}</div>
      ${extra}
      <div class="sec-title mt">An√°lisis Detallado</div>
      <div class="sc-narrative">${s.analysis||''}</div>
    </div>
    <div class="sc-actions">
      <button class="btn primary sm" onclick="quickAdd('${s.ticker}','${s.asset_type||'stock'}')">+ Agregar al portfolio</button>
      <button class="btn sm" onclick="toChat('Profundiz√° el an√°lisis de ${s.ticker}: estrategia exacta de entrada y salida seg√∫n escalera Quinelli')">Profundizar en chat ‚Üí</button>
    </div>`;
    c.appendChild(div);
  });
}

function quickAdd(ticker,type){document.getElementById('m-t').value=ticker;document.getElementById('m-tp').value=type;openModal()}

// ‚ïê‚ïê PORTFOLIO ‚ïê‚ïê
function openModal(){document.getElementById('m-d').value=new Date().toISOString().split('T')[0];document.getElementById('addModal').classList.add('show')}
function closeModal(){document.getElementById('addModal').classList.remove('show');['m-t','m-q','m-p','m-c','m-n'].forEach(id=>document.getElementById(id).value='')}

function addPosition(){
  const ticker=document.getElementById('m-t').value.trim().toUpperCase();
  const type=document.getElementById('m-tp').value;
  const qty=parseFloat(document.getElementById('m-q').value);
  const price=parseFloat(document.getElementById('m-p').value);
  const current=parseFloat(document.getElementById('m-c').value)||price;
  const date=document.getElementById('m-d').value;
  const notes=document.getElementById('m-n').value;
  if(!ticker||!qty||!price){alert('Complet√° ticker, cantidad y precio.');return}
  const ex=portfolio.find(p=>p.ticker===ticker&&p.type===type);
  if(ex){const tq=ex.qty+qty;ex.avgPrice=(ex.avgPrice*ex.qty+price*qty)/tq;ex.qty=tq;ex.currentPrice=current}
  else portfolio.push({id:Date.now(),ticker,type,qty,avgPrice:price,currentPrice:current,date,notes,verdict:'MANTENER'});
  history.unshift({id:Date.now(),date,ticker,type,op:'COMPRA',qty,price,notes});
  save();closeModal();renderPortfolio();updateKPIs();renderAlerts();
}

function removePos(id){if(!confirm('¬øEliminar posici√≥n?'))return;portfolio=portfolio.filter(p=>p.id!==id);save();renderPortfolio();updateKPIs();renderAlerts()}

function updatePrice(id){
  const p=portfolio.find(x=>x.id===id);if(!p)return;
  const np=prompt(`Precio actual de ${p.ticker} ($):`,p.currentPrice);
  if(np&&!isNaN(parseFloat(np))){p.currentPrice=parseFloat(np);save();renderPortfolio();updateKPIs();renderAlerts()}
}

function renderPortfolio(){
  const tbody=document.getElementById('portBody');
  let tv=0,tc=0;
  if(portfolio.length===0){document.getElementById('portEmpty').style.display='block';document.getElementById('portTable').style.display='none'}
  else{
    document.getElementById('portEmpty').style.display='none';document.getElementById('portTable').style.display='table';
    tbody.innerHTML=portfolio.map(p=>{
      const cost=p.avgPrice*p.qty,val=p.currentPrice*p.qty,pnl=val-cost,pnlPct=((pnl/cost)*100).toFixed(2);
      tv+=val;tc+=cost;
      const vk=(p.verdict||'MANTENER').toUpperCase().replace(/\s+/g,'_');
      return`<tr><td><span class="pt-ticker">${p.ticker}</span></td><td><span class="pt-type">${p.type.toUpperCase()}</span></td><td>${p.qty}</td><td>$${p.avgPrice.toFixed(2)}</td><td>$${p.currentPrice.toFixed(2)}</td><td class="pt-pnl ${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}$${pnl.toFixed(2)}</td><td class="pt-pnl ${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}${pnlPct}%</td><td><span class="pt-verdict ${vk}">${VM[vk]||p.verdict}</span></td><td style="display:flex;gap:5px;"><button class="btn sm" onclick="updatePrice(${p.id})">‚Üª</button><button class="btn sm" onclick="removePos(${p.id})">‚úï</button></td></tr>`;
    }).join('');
  }
  const tp=tv-tc,pPct=tc>0?((tp/tc)*100).toFixed(2):'0.00';
  document.getElementById('p-total').textContent='$'+tv.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  document.getElementById('p-cnt').textContent=portfolio.length+' posici√≥n'+(portfolio.length!==1?'es':'');
  document.getElementById('p-pnl').textContent=(tp>=0?'+':'')+'$'+tp.toFixed(2);
  document.getElementById('p-pct').textContent=(tp>=0?'+':'')+pPct+'%';
  document.getElementById('p-real').textContent='$0.00';
  if(history.length===0){document.getElementById('histEmpty').style.display='block';document.getElementById('histTable').style.display='none'}
  else{
    document.getElementById('histEmpty').style.display='none';document.getElementById('histTable').style.display='table';
    document.getElementById('histBody').innerHTML=history.slice(0,40).map(h=>`<tr><td>${h.date}</td><td><span class="pt-ticker" style="font-size:13px">${h.ticker}</span></td><td><span class="pt-type">${h.type.toUpperCase()}</span></td><td class="${h.op==='COMPRA'?'op-buy':'op-sell'}">${h.op}</td><td>${h.qty}</td><td>$${parseFloat(h.price).toFixed(2)}</td><td>$${(h.qty*h.price).toFixed(2)}</td><td style="font-size:9px;color:var(--text3)">${h.notes||'‚Äî'}</td></tr>`).join('');
  }
}

async function refreshVerdicts(){
  if(portfolio.length===0)return;
  const tickers=[...new Set(portfolio.map(p=>p.ticker))];
  try{
    const txt=await api([{role:'user',content:buildAnalysisPrompt(tickers,'all')}]);
    const d=parseJ(txt);
    (d.stocks||[]).forEach(s=>{const pos=portfolio.find(p=>p.ticker===s.ticker);if(pos)pos.verdict=s.verdict});
    save();renderPortfolio();renderAlerts();
  }catch(e){alert('Error: '+e.message)}
}

// ‚ïê‚ïê KPIs + ALERTS ‚ïê‚ïê
function updateKPIs(){
  let tv=0,tc=0,bestPct=-9999,bestT='‚Äî',bestS='‚Äî';
  portfolio.forEach(p=>{const val=p.currentPrice*p.qty,cost=p.avgPrice*p.qty,pct=(val-cost)/cost*100;tv+=val;tc+=cost;if(pct>bestPct){bestPct=pct;bestT=p.ticker;bestS=(pct>=0?'+':'')+pct.toFixed(1)+'%'}});
  const tp=tv-tc,pPct=tc>0?((tp/tc)*100).toFixed(2):'0.00';
  const aC=portfolio.filter(p=>Math.abs((p.currentPrice-p.avgPrice)/p.avgPrice*100)>=15).length;
  document.getElementById('k-total').textContent='$'+tv.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  document.getElementById('k-pos').textContent=portfolio.length+' posiciones';
  document.getElementById('k-pnl').textContent=(tp>=0?'+':'')+'$'+Math.abs(tp).toFixed(0);
  document.getElementById('k-pnl-pct').textContent=(tp>=0?'+':'')+pPct+'%';
  document.getElementById('k-best').textContent=bestT;
  document.getElementById('k-best-sub').textContent=bestS;
  document.getElementById('k-alerts').textContent=aC;
}

function renderAlerts(){
  const c=document.getElementById('alertsWidget');
  if(portfolio.length===0){c.innerHTML='<div style="font-size:10px;color:var(--text3);text-align:center;padding:20px;letter-spacing:2px;">AGREG√Å POSICIONES PARA VER ALERTAS</div>';return}
  const alerts=portfolio.map(p=>{
    const pct=(p.currentPrice-p.avgPrice)/p.avgPrice*100;
    let tp='watch',msg='';
    if(pct<=-35){tp='buy';msg=`‚ö† Ca√≠da ${pct.toFixed(1)}% ¬∑ Escal√≥n FUERTE. Completar posici√≥n.`}
    else if(pct<=-25){tp='buy';msg=`Ca√≠da ${pct.toFixed(1)}% ¬∑ Escal√≥n -25%. Comprar 25% adicional.`}
    else if(pct<=-15){tp='buy';msg=`Ca√≠da ${pct.toFixed(1)}% ¬∑ Escal√≥n -15%. Primera compra (10%).`}
    else if(pct>=60){tp='sell';msg=`Subida +${pct.toFixed(1)}% ¬∑ Escal√≥n +60%. Vender 40%.`}
    else if(pct>=45){tp='sell';msg=`Subida +${pct.toFixed(1)}% ¬∑ Escal√≥n +45%. Vender 30%.`}
    else if(pct>=35){tp='sell';msg=`Subida +${pct.toFixed(1)}% ¬∑ Escal√≥n +35%. Vender 20%.`}
    else if(pct>=25){tp='sell';msg=`Subida +${pct.toFixed(1)}% ¬∑ Escal√≥n +25%. Vender 10%.`}
    else{tp='watch';msg=`${pct.toFixed(1)}% desde entrada ¬∑ Mantener posici√≥n.`}
    return{ticker:p.ticker,tp,msg,pct};
  }).sort((a,b)=>Math.abs(b.pct)-Math.abs(a.pct));
  c.innerHTML=alerts.slice(0,6).map(a=>`<div class="alert-item"><div class="alert-dot ${a.tp}"></div><div><div class="alert-ticker">${a.ticker}</div><div class="alert-msg">${a.msg}</div></div></div>`).join('');
}

function refreshAll(){updateKPIs();renderAlerts()}

// ‚ïê‚ïê SUGGESTIONS ‚ïê‚ïê
async function loadSuggestions(){
  document.getElementById('sLoading').style.display='block';
  document.getElementById('sugContainer').innerHTML='';
  document.getElementById('sugWidget').innerHTML='<div class="load-pulse"><span></span><span></span><span></span></div>';
  const portCtx=portfolio.length>0?`El usuario ya tiene: ${portfolio.map(p=>p.ticker).join(', ')}. Prefer√≠ no repetir salvo motivo fuerte.`:'';
  try{
    const txt=await api([{role:'user',content:`Sos el Agente Quinelli. Identific√° las mejores oportunidades del mercado EE.UU. hoy seg√∫n el Framework Quinelli 2026.
${portCtx}
Gener√° 8-10 oportunidades diversificadas:
- 3-4 acciones COMPRA o COMPRA_AGRESIVA (calidad alta + correcci√≥n t√©cnica)
- 2-3 ETF para largo plazo
- 1-2 compounders en MANTENER con nota de cu√°ndo comprar
- 1 opci√≥n con setup claro si aplica
Para cada uno explic√° POR QU√â es oportunidad AHORA seg√∫n escalera y contexto 2025-2026.
SOLO JSON:
\`\`\`json
{"suggestions":[{"ticker":"NVDA","company":"NVIDIA Corporation","sector":"Semiconductores","asset_type":"stock","verdict":"COMPRA","score":88,"why":"Correcci√≥n t√©cnica -18% desde m√°ximos sin deterioro estructural. IA mantiene moat. ROE>120%, FCF record.","entry_note":"Zona entrada $118-125. Escal√≥n -15% activado."}]}
\`\`\``}]);
    const d=parseJ(txt);suggs=d.suggestions||[];save();renderSuggs();renderSuggWidget();setBadge();
  }catch(e){document.getElementById('sugContainer').innerHTML=`<div style="background:var(--red-dim);border:1px solid rgba(248,113,113,.3);padding:14px;font-size:11px;color:var(--red);">‚ö† ${e.message}</div>`}
  finally{document.getElementById('sLoading').style.display='none'}
}

function setBadge(){const n=suggs.filter(s=>s.verdict==='COMPRA'||s.verdict==='COMPRA_AGRESIVA').length;const b=document.getElementById('sugBadge');b.textContent=n;b.style.display=n>0?'':'none'}

function filterSug(btn,f){document.querySelectorAll('.sug-controls .tf').forEach(b=>b.classList.remove('active'));btn.classList.add('active');sugFilter=f;renderSuggs()}

function renderSuggs(){
  const c=document.getElementById('sugContainer');
  let filtered=suggs;
  if(sugFilter!=='all'){if(sugFilter==='etf'||sugFilter==='option')filtered=suggs.filter(s=>s.asset_type===sugFilter);else filtered=suggs.filter(s=>s.verdict===sugFilter)}
  if(filtered.length===0){c.innerHTML='<div style="font-size:10px;color:var(--text3);letter-spacing:2px;padding:20px;">SIN RESULTADOS PARA ESTE FILTRO</div>';return}
  c.innerHTML=filtered.map(s=>{
    const vk=(s.verdict||'MANTENER').toUpperCase().replace(/\s+/g,'_');
    return`<div class="sug-card" onclick="analyzeTicker('${s.ticker}')">
      <div class="sug-card-ticker">${s.ticker}</div>
      <div class="sug-card-info">
        <div class="sug-card-name">${s.company||''} <span style="font-size:8px;color:var(--text3);margin-left:6px">${(s.asset_type||'stock').toUpperCase()} ¬∑ ${s.sector||''}</span></div>
        <div class="sug-card-why">${s.why||''}</div>
        ${s.entry_note?`<div style="font-size:9px;color:var(--gold);margin-top:3px;opacity:.8">${s.entry_note}</div>`:''}
      </div>
      <div class="sug-card-meta">
        <div class="sug-v ${vk}" style="color:${vk==='COMPRA_AGRESIVA'?'#22c55e':vk==='COMPRA'?'var(--green)':vk==='MANTENER'?'var(--yellow)':vk==='VENTA'?'#fb923c':'var(--red)'};border-color:currentColor;">${VM[vk]||s.verdict}</div>
        <div style="font-size:10px;color:var(--text3)">Score: ${s.score||'‚Äî'}</div>
      </div>
    </div>`;
  }).join('');
}

function renderSuggWidget(){
  const w=document.getElementById('sugWidget');
  const top=suggs.slice(0,4);
  w.innerHTML=top.map(s=>{const vk=(s.verdict||'MANTENER').toUpperCase().replace(/\s+/g,'_');return`<div class="sug-item" onclick="analyzeTicker('${s.ticker}')"><div><div class="si-ticker">${s.ticker}</div><div class="si-name">${s.company||''}</div></div><div class="si-verdict ${vk}" style="color:${vk==='COMPRA_AGRESIVA'?'#22c55e':vk==='COMPRA'?'var(--green)':vk==='MANTENER'?'var(--yellow)':'var(--red)'};border-color:currentColor;">${VM[vk]||s.verdict}</div><div class="si-score">${s.score||'‚Äî'}</div></div>`}).join('')||'<div style="font-size:10px;color:var(--text3);padding:10px;">Sin sugerencias a√∫n</div>';
}

function analyzeTicker(t){document.getElementById('aiInput').value=t;showView('analisis');runAnalysis()}

// ‚ïê‚ïê CHAT ‚ïê‚ïê
function getTime(){return new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}

function appendMsg(role,html){
  const c=document.getElementById('chatMsgs');
  const d=document.createElement('div');d.className='msg '+role;
  d.innerHTML=`<div class="msg-av">${role==='agent'?'Q':'‚óà'}</div><div><div class="msg-bubble">${html}</div><div class="msg-time">${getTime()} ¬∑ ${role==='agent'?'QUINELLI AGENT':'VOS'}</div></div>`;
  c.appendChild(d);c.scrollTop=c.scrollHeight;return d;
}

function appendLoading(){
  const c=document.getElementById('chatMsgs');
  const d=document.createElement('div');d.className='msg agent';
  d.innerHTML=`<div class="msg-av">Q</div><div><div class="msg-bubble"><div class="load-pulse"><span></span><span></span><span></span></div></div></div>`;
  c.appendChild(d);c.scrollTop=c.scrollHeight;return d;
}

async function sendChat(){
  const input=document.getElementById('chatInput');
  const txt=input.value.trim();if(!txt)return;
  input.value='';
  appendMsg('user',txt);
  chatHist.push({role:'user',content:txt});
  const ld=appendLoading();
  const portCtx=portfolio.length>0?`\n\nPortfolio del usuario: ${portfolio.map(p=>`${p.ticker} entrada $${p.avgPrice.toFixed(2)} actual $${p.currentPrice.toFixed(2)} qty ${p.qty}`).join(', ')}.`:'';
  const sys=`Sos el Agente Quinelli, experto en inversi√≥n del mercado de EE.UU. Framework Quinelli Evolucionado 2026.
FILOSOF√çA: comprar en ca√≠das relevantes, vender parcialmente en subidas, disciplina + paciencia = crecimiento compuesto.
FILTRO CALIDAD: ROE>18-20% sostenido, FCF positivo+creciente, D/E controlado, EPS growth consistente, moat.
ESCALERA COMPRA: -5% mantener, -15% comprar 10%, -25% comprar 25%, -35% completar.
ESCALERA VENTA: +25% vender 10%, +35% vender 20%, +45% vender 30%, +60% vender 40%, +100% considerar cierre (compounders: n√∫cleo 20-30%).
DIAGN√ìSTICO CA√çDA: mercado general / evento temporal / deterioro estructural.
T√âCNICA: BOS (cuerpo vela), HH+HL alcista, LL+LH bajista, CHoCH.
VEREDICTO 5 niveles: COMPRA_AGRESIVA / COMPRA / MANTENER / VENTA / VENTA_AGRESIVA.
OPCIONES: analiz√°s underlying, CALL/PUT, strike, expiraci√≥n, IV, delta, theta, timing con escalera.${portCtx}
Respond√© en espa√±ol, de forma directa y precisa. Pod√©s usar **negrita** para conceptos clave.`;
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:sys,messages:chatHist.slice(-10)})});
    const data=await r.json();
    const reply=data.content?.find(b=>b.type==='text')?.text||'No pude procesar.';
    chatHist.push({role:'assistant',content:reply});
    ld.remove();
    const fmt=reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
    appendMsg('agent',fmt);
  }catch(e){ld.remove();appendMsg('agent','‚ö† Error: '+e.message)}
}

function sendQ(txt){document.getElementById('chatInput').value=txt;sendChat()}
function toChat(txt){showView('chat');document.getElementById('chatInput').value=txt;sendChat()}
function clearChat(){chatHist=[];document.getElementById('chatMsgs').innerHTML=`<div class="msg agent"><div class="msg-av">Q</div><div><div class="msg-bubble">Nueva sesi√≥n iniciada. ¬øEn qu√© puedo ayudarte?</div><div class="msg-time">${getTime()} ¬∑ QUINELLI AGENT</div></div></div>`}
</script>

</body>
</html>